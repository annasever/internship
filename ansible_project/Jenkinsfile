pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID = credentials('aws-access-key-id') 
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
        ANSIBLE_SSH_PRIVATE_KEY_FILE = credentials('private-key') 
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scmGit(branches: [[name: '*/SCRUM-7.TF_Ansible_Jenkins']], extensions: [], userRemoteConfigs: [[credentialsId: 'jenkins-git', url: 'git@github.com:annasever/internship.git']])
            }
        }

        stage('Run Ansible Playbook with Vault') {
            steps {
                dir('ansible_project') {
                    withCredentials([string(credentialsId: 'vault_password', variable: 'VAULT_PASS')]) {
                        writeFile file: 'vault_password.txt', text: "${VAULT_PASS}"
                        sh '''
                            ansible-playbook playbook.yml -i aws_ec2.yml --vault-password-file vault_password.txt --private-key="$ANSIBLE_SSH_PRIVATE_KEY_FILE"
                        '''
                    }
                }
            }
        }

        stage('Extract Backend URL') {
            steps {
                dir('ansible_project') {
                    script {
                        def backendIp = sh(script: "ansible -i aws_ec2.yml -m debug -a \"msg={{ hostvars[groups['tag_Name_backend'][0]].ansible_host }}\" tag_Name_backend --vault-password-file vault_password.txt", returnStdout: true).trim()
                        echo "Backend IP: ${backendIp}"

                        backendIp = backendIp.replaceAll(/.*\|\s+SUCCESS\s+=>\s+\{.*"msg":\s+"([^"]+)".*/, '$1')
                        echo "Parsed Backend IP: ${backendIp}"
                        writeFile file: 'backend_ip.txt', text: backendIp
                    }
                }
            }
        }

        stage('Update Frontend .env Configuration') {
            steps {
                dir('ansible_project') {
                    script {
                        def backendIp = readFile('backend_ip.txt').trim()
                             sh """
                                echo 'REACT_APP_API_BASE_URL="http://${backendIp}:8080"'  | sudo tee /var/www/frontend/.env > /dev/null
                            """
                        }
                    }
                }
            }

        stage('Deploy Frontend') {
            steps {
                dir('ansible_project') {
                    script {
                        sh "ansible-playbook frontend-playbook.yml -i aws_ec2.yml --vault-password-file vault_password.txt"
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'Ansible playbook executed successfully, and frontend is updated with backend IP in .env file.'
        }
        failure {
            echo 'Ansible playbook execution failed.'
        }
    }
}
